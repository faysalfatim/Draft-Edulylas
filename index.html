<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduLylas Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { color-scheme: light; }
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding-top: 64px;
      padding-bottom: 96px;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .modal-backdrop { background: rgba(15, 23, 42, 0.7); }
    .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
    .focus-ring:focus { outline: 2px solid #2563eb; outline-offset: 2px; }
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      z-index: 1000;
      background: #fff;
      box-shadow: 0 1px 10px rgba(15,23,42,0.08);
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 64px;
      z-index: 999;
      background: #fff;
      border-top: 1px solid #e2e8f0;
      box-shadow: 0 -2px 10px rgba(15,23,42,0.05);
    }
    .playbook-card img {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 1rem;
    }
    .episode-panel {
      background: #f8fafc;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 0.75rem;
    }
    .modal-shell {
      max-height: 90vh;
      overflow-y: auto;
    }
    @media (max-width: 640px) {
      .top-header nav { display: none; }
      body { padding-bottom: 140px; }
    }
    @media (min-width: 641px) {
      .bottom-nav { display: none; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <header class="top-header">
    <div class="max-w-6xl h-full mx-auto px-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <button id="creatorToggle" class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center font-semibold focus-ring" aria-label="Switch account">EL</button>
        <div>
          <p class="font-bold">EduLylas</p>
          <p class="text-xs text-blue-500">#‡¶∂‡ßá‡¶ñ‡¶æ‡¶∞‡¶Ö‡¶≠‡¶ø‡¶Ø‡¶æ‡¶®</p>
        </div>
      </div>
      <div class="hidden md:block flex-1">
        <label class="sr-only" for="searchInput">Search playbooks</label>
        <input id="searchInput" class="w-full border border-slate-200 rounded-xl px-4 py-2 focus:ring focus:ring-blue-100" placeholder="Search topics, playbooks, creators‚Ä¶" />
      </div>
      <nav aria-label="Primary">
        <div class="hidden sm:flex gap-4 text-sm font-semibold">
          <button class="nav-btn focus-ring" data-view="home">Home</button>
          <button class="nav-btn focus-ring" data-view="search">Search</button>
          <button class="nav-btn focus-ring" data-view="creator">Create</button>
          <button class="nav-btn focus-ring" data-view="profile">Profile</button>
        </div>
      </nav>
      <div id="navUser" class="flex items-center gap-2"></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-6 space-y-6" id="appRoot">
    <div class="md:hidden mt-4">
      <label class="sr-only" for="searchInputMobile">Search playbooks</label>
      <input id="searchInputMobile" class="w-full border border-slate-200 rounded-xl px-4 py-2 focus:ring focus:ring-blue-100" placeholder="Search topics, playbooks, creators‚Ä¶" />
    </div>

    <details class="bg-white rounded-2xl shadow p-4" open>
      <summary class="font-semibold cursor-pointer">README ‚Ä¢ Demo Instructions</summary>
      <div class="mt-3 text-sm space-y-2">
        <p>Save this file as <strong>index.html</strong> and open it directly in Chrome/Edge. All demo data persists in <code>localStorage</code>; no server needed. For iframe embeds (YouTube, Medium, Dev.to) best results happen when you run <code>npx serve .</code> so browsers allow the secure embeds.</p>
        <p>Auto-login user: <strong>dev@edulylas.test</strong>. Use the ‚ÄúEL‚Äù avatar button to switch to creator <strong>creator@edulylas.test</strong>.</p>
        <p>Payments are simulated client-side. Unlock anything locked to see the payment flow. Purchases land in <code>edulylas_purchases</code> and unlocks in <code>edulylas_unlocks</code>. Debug panel lets you simulate webhook failures or reseed storage.</p>
      </div>
    </details>

    <section class="flex flex-wrap gap-2" id="categoryShortcuts" aria-label="Categories"></section>

    <section>
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Trending Playbooks</h2>
        <span class="text-xs text-slate-500">‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá &amp; ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶Æ‡¶ø‡¶∂‡ßç‡¶∞‡¶ø‡¶§</span>
      </div>
      <div id="trendingCarousel" class="flex space-x-4 overflow-x-auto scrollbar-hide pb-2" aria-label="Trending playbooks"></div>
    </section>

    <section>
      <h2 class="text-lg font-semibold mb-3">Recommended For You</h2>
      <div id="recommendedFeed" class="space-y-4"></div>
    </section>

    <section id="playbookPreview" class="bg-white rounded-2xl shadow p-4"></section>
    <section id="playbookDetails" class="bg-white rounded-2xl shadow p-4"></section>
    <section id="episodePlayer" class="bg-white rounded-2xl shadow p-4"></section>
    <section id="creatorPanel" class="hidden bg-white rounded-2xl shadow p-4"></section>
    <section id="profilePanel" class="bg-white rounded-2xl shadow p-4"></section>
  </main>

  <nav class="bottom-nav" aria-label="Mobile navigation">
    <div class="max-w-6xl mx-auto h-full px-6 flex items-center justify-between text-sm font-semibold text-slate-500">
      <button class="nav-btn focus-ring flex flex-col items-center" data-view="home" aria-label="Home">
        <span class="material-icons text-xl">home</span>
        Home
      </button>
      <button class="nav-btn focus-ring flex flex-col items-center" data-view="search" aria-label="Search">
        <span class="material-icons text-xl">search</span>
        Search
      </button>
      <button class="nav-btn focus-ring flex flex-col items-center" data-view="creator" aria-label="Create">
        <span class="material-icons text-xl">add_circle</span>
        Create
      </button>
      <button class="nav-btn focus-ring flex flex-col items-center" data-view="profile" aria-label="Profile">
        <span class="material-icons text-xl">person</span>
        Profile
      </button>
    </div>
  </nav>
  <div id="paymentModal" class="hidden fixed inset-0 z-[1100] items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="paymentTitle">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="modal-shell relative bg-white rounded-2xl shadow-2xl w-11/12 max-w-xl p-6 space-y-4" tabindex="-1">
      <button id="closePayment" class="absolute top-3 right-3 text-slate-500 focus-ring" aria-label="Close payment">‚úï</button>
      <div>
        <h3 id="paymentTitle" class="text-xl font-semibold">Unlock Playbook</h3>
        <p id="paymentPlaybookTitle" class="text-sm text-slate-500"></p>
      </div>
      <div class="flex space-x-3" role="tablist">
        <button class="payment-tab tab-active focus-ring" data-provider="card" role="tab" aria-selected="true">Card</button>
        <button class="payment-tab focus-ring" data-provider="bkash" role="tab" aria-selected="false">bKash</button>
        <button class="payment-tab focus-ring" data-provider="nagad" role="tab" aria-selected="false">Nagad</button>
      </div>
      <form id="paymentContent" class="space-y-3 text-sm" autocomplete="off"></form>
      <div id="paymentStatus" class="text-sm" role="status"></div>
      <button id="payNowBtn" class="w-full bg-blue-600 text-white rounded-xl py-2 font-semibold focus-ring" type="button">Pay ‡ß≥<span id="payAmountLabel"></span></button>
    </div>
  </div>

  <div id="receiptModal" class="hidden fixed inset-0 z-[1200] items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="receiptTitle">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="modal-shell relative bg-white rounded-2xl shadow-2xl w-11/12 max-w-lg p-6 space-y-4" tabindex="-1">
      <button id="closeReceipt" class="absolute top-3 right-3 text-slate-500 focus-ring" aria-label="Close receipt">‚úï</button>
      <div class="text-center">
        <p class="text-xs uppercase tracking-widest text-slate-500">EduLylas Receipt</p>
        <h3 id="receiptTitle" class="text-xl font-semibold mt-1">Purchase Confirmed</h3>
      </div>
      <dl class="grid grid-cols-2 gap-3 text-sm">
        <div><dt class="text-slate-500">Playbook</dt><dd id="receiptPlaybook" class="font-semibold"></dd></div>
        <div><dt class="text-slate-500">Amount</dt><dd id="receiptAmount" class="font-semibold"></dd></div>
        <div><dt class="text-slate-500">Provider</dt><dd id="receiptProvider" class="font-semibold"></dd></div>
        <div><dt class="text-slate-500">Transaction</dt><dd id="receiptTxn" class="font-mono text-xs"></dd></div>
        <div class="col-span-2"><dt class="text-slate-500">Date</dt><dd id="receiptDate" class="font-semibold"></dd></div>
      </dl>
      <div class="flex flex-wrap gap-3">
        <button id="printReceipt" class="flex-1 border border-slate-300 rounded-xl py-2 focus-ring" type="button">Print / Save</button>
        <button id="viewPlaybookBtn" class="flex-1 bg-blue-600 text-white rounded-xl py-2 focus-ring" type="button">View Playbook</button>
      </div>
    </div>
  </div>

  <button id="debugToggle" class="fixed bottom-24 right-4 z-[1300] bg-slate-900 text-white px-3 py-2 rounded-full text-sm shadow-lg focus-ring" aria-expanded="false">Debug</button>
  <section id="debugPanel" class="hidden fixed bottom-24 right-4 z-[1200] bg-white rounded-2xl shadow-2xl w-80 p-4 space-y-3" aria-live="polite">
    <h4 class="font-semibold text-sm">Debug Controls</h4>
    <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="failWebhookToggle" class="focus-ring"/> Simulate webhook failure</label>
    <button id="forceReseed" class="w-full bg-amber-500 text-white rounded-xl py-2 text-sm focus-ring">Force re-seed demo data</button>
    <button id="refreshStorage" class="w-full border border-slate-300 rounded-xl py-2 text-sm focus-ring">Refresh localStorage view</button>
    <pre id="storageDump" class="bg-slate-50 rounded-xl p-2 text-[11px] overflow-auto h-32"></pre>
  </section>

  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[1400] hidden"></div>
  <script>
    const storeKeys = {
      users: 'edulylas_users',
      playbooks: 'edulylas_playbooks',
      episodes: 'edulylas_episodes',
      purchases: 'edulylas_purchases',
      unlocks: 'edulylas_unlocks',
      comments: 'edulylas_comments',
      currentUser: 'edulylas_current_user'
    };
    const allowedEmbedDomains = ['youtube.com', 'youtu.be', 'medium.com', 'dev.to'];
    const fallbackThumbnail = 'https://via.placeholder.com/480x270?text=No+Image';

    const appState = {
      activePlaybookId: null,
      activeEpisodeId: null,
      pendingProvider: 'card',
      processingPayment: false,
      debug: { webhookFailure: false },
      focusTrap: null,
      nagadAttempts: 0
    };

    function uuidv4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function saveToStore(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
      document.dispatchEvent(new CustomEvent('app:data:changed', { detail: { key } }));
    }
    function getFromStore(key) {
      const raw = localStorage.getItem(key);
      try { return raw ? JSON.parse(raw) : null; } catch { return null; }
    }

    function seedData(force = false) {
      if (!force && getFromStore(storeKeys.users)) return;
      const users = [
        { id: 'u1', name: 'Dev Learner', email: 'dev@edulylas.test', isCreator: false, avatarUrl: 'https://i.pravatar.cc/80?img=12' },
        { id: 'u2', name: 'OpenSource Academy', email: 'creator@edulylas.test', isCreator: true, avatarUrl: 'https://i.pravatar.cc/80?img=32' }
      ];
      const playbooks = [
        { id: 'pb_python', slug: 'python-programming-playbook', title: 'Python Programming Playbook', creatorId: 'u2', creatorName: 'OpenSource Academy', description: 'Beginner‚ÜíPro Python with projects. First 2 episodes free; rest locked.', tags: ['Tech','Programming'], difficulty: 'Beginner‚ÜíIntermediate', rating: 4.7, priceTaka: 499, thumbnailUrl: 'https://img.youtube.com/vi/rfscVS0vtbw/hqdefault.jpg', totalEpisodes: 6, createdAt: '2025-10-01T09:00:00Z' },
        { id: 'pb_marketing', slug: 'digital-marketing-master-playbook-2025', title: 'Digital Marketing Master Playbook 2025', creatorId: 'u2', creatorName: 'OpenSource Academy', description: 'Campaign blueprints covering SEO, PPC, funnels.', tags: ['Marketing','Business'], difficulty: 'Intermediate', rating: 4.6, priceTaka: 399, thumbnailUrl: 'https://via.placeholder.com/480x270?text=Digital+Marketing', totalEpisodes: 8, createdAt: '2025-09-12T09:00:00Z' },
        { id: 'pb_uiux', slug: 'ui-ux-design-crash-playbook', title: 'UI/UX Design Crash Playbook', creatorId: 'u2', creatorName: 'OpenSource Academy', description: 'Sketch to prototype: UX research, UI systems, and usability.', tags: ['Design','Tech'], difficulty: 'Beginner', rating: 4.8, priceTaka: 349, thumbnailUrl: 'https://via.placeholder.com/480x270?text=UI%2FUX+Design', totalEpisodes: 8, createdAt: '2025-08-05T09:00:00Z' },
        { id: 'pb_ai', slug: 'ai-machine-learning-starter-pack', title: 'AI & Machine Learning Starter Pack', creatorId: 'u2', creatorName: 'OpenSource Academy', description: 'Math-light intro to AI/ML workflows and tools.', tags: ['AI/ML','Tech'], difficulty: 'Intermediate', rating: 4.9, priceTaka: 599, thumbnailUrl: 'https://via.placeholder.com/480x270?text=AI+ML', totalEpisodes: 7, createdAt: '2025-11-10T09:00:00Z' },
        { id: 'pb_fullstack', slug: 'full-stack-web-development-2025', title: 'Full-Stack Web Development 2025', creatorId: 'u2', creatorName: 'OpenSource Academy', description: 'Modern MERN stack with Edge deployments.', tags: ['Tech'], difficulty: 'Intermediate', rating: 4.5, priceTaka: 499, thumbnailUrl: 'https://via.placeholder.com/480x270?text=Full+Stack+2025', totalEpisodes: 9, createdAt: '2025-10-21T09:00:00Z' },
        { id: 'pb_ba', slug: 'business-analytics-excel-powerbi', title: 'Business Analytics with Excel & Power BI', creatorId: 'u2', creatorName: 'OpenSource Academy', description: 'Dashboards, KPIs, Power Query recipes.', tags: ['Business'], difficulty: 'Beginner', rating: 4.4, priceTaka: 349, thumbnailUrl: 'https://via.placeholder.com/480x270?text=Analytics', totalEpisodes: 6, createdAt: '2025-09-25T09:00:00Z' },
        { id: 'pb_startup', slug: 'entrepreneurship-startup-playbook', title: 'Entrepreneurship & Startup Playbook', creatorId: 'u2', creatorName: 'OpenSource Academy', description: 'Idea validation to funding decks.', tags: ['Business'], difficulty: 'All Levels', rating: 4.3, priceTaka: 299, thumbnailUrl: 'https://via.placeholder.com/480x270?text=Startup', totalEpisodes: 7, createdAt: '2025-07-18T09:00:00Z' }
      ];
      const episodes = [
        { id:'ep_py_1', playbookId:'pb_python', title:'Intro to Python', description:'Overview, setup, why Python.', embedUrl:'https://www.youtube.com/embed/rfscVS0vtbw', thumbnailUrl:'https://img.youtube.com/vi/rfscVS0vtbw/hqdefault.jpg', order:1, isFree:true, durationSeconds:600 },
        { id:'ep_py_2', playbookId:'pb_python', title:'Variables & Data Types', description:'Basics of variables, lists, dicts.', embedUrl:'https://www.youtube.com/embed/_uQrJ0TkZlc', thumbnailUrl:'https://img.youtube.com/vi/_uQrJ0TkZlc/hqdefault.jpg', order:2, isFree:true, durationSeconds:900 },
        { id:'ep_py_3', playbookId:'pb_python', title:'Control Flow', description:'Conditionals and loops.', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Control+Flow', order:3, isFree:false, durationSeconds:1200 },
        { id:'ep_py_4', playbookId:'pb_python', title:'Functions & Modules', description:'Modular design and functions.', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Functions', order:4, isFree:false, durationSeconds:1300 },
        { id:'ep_py_5', playbookId:'pb_python', title:'OOP Basics', description:'Classes, objects, inheritance.', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+OOP', order:5, isFree:false, durationSeconds:1500 },
        { id:'ep_py_6', playbookId:'pb_python', title:'Build a CLI Project', description:'Project: CLI todo app.', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+CLI+Project', order:6, isFree:false, durationSeconds:1800 },
        { id:'ep_dm_1', playbookId:'pb_marketing', title:'Intro to Digital Marketing', description:'Marketing fundamentals.', embedUrl:'https://www.youtube.com/embed/3m3H5gqk4_k', thumbnailUrl:'https://img.youtube.com/vi/3m3H5gqk4_k/hqdefault.jpg', order:1, isFree:true, durationSeconds:720 },
        { id:'ep_dm_2', playbookId:'pb_marketing', title:'SEO Basics', description:'Keyword research & on-page SEO.', embedUrl:'https://www.youtube.com/embed/5WpwzKJq0Ck', thumbnailUrl:'https://img.youtube.com/vi/5WpwzKJq0Ck/hqdefault.jpg', order:2, isFree:true, durationSeconds:800 },
        { id:'ep_dm_3', playbookId:'pb_marketing', title:'Paid Ads Foundations', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Ads', order:3, isFree:false, durationSeconds:900 },
        { id:'ep_dm_4', playbookId:'pb_marketing', title:'Funnels & Automation', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Funnels', order:4, isFree:false, durationSeconds:1000 },
        { id:'ep_dm_5', playbookId:'pb_marketing', title:'Email Marketing', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Email', order:5, isFree:false, durationSeconds:1000 },
        { id:'ep_dm_6', playbookId:'pb_marketing', title:'Analytics & Reporting', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Analytics', order:6, isFree:false, durationSeconds:1000 },
        { id:'ep_dm_7', playbookId:'pb_marketing', title:'Retention Strategies', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Retention', order:7, isFree:false, durationSeconds:1000 },
        { id:'ep_dm_8', playbookId:'pb_marketing', title:'Scaling Playbooks', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Scaling', order:8, isFree:false, durationSeconds:1000 },
        { id:'ep_uiux_1', playbookId:'pb_uiux', title:'Design Thinking Sprint', description:'How to empathize & define problems.', embedUrl:'https://www.youtube.com/embed/3W3w2YQ1kKM', thumbnailUrl:'https://img.youtube.com/vi/3W3w2YQ1kKM/hqdefault.jpg', order:1, isFree:true, durationSeconds:780 },
        { id:'ep_uiux_2', playbookId:'pb_uiux', title:'User Research Basics', description:'Interview frameworks.', embedUrl:'https://www.youtube.com/embed/FZgqRL0vh6U', thumbnailUrl:'https://img.youtube.com/vi/FZgqRL0vh6U/hqdefault.jpg', order:2, isFree:true, durationSeconds:900 },
        { id:'ep_uiux_3', playbookId:'pb_uiux', title:'Wireframing Essentials', description:'Low-fi to hi-fi workflow.', embedUrl:'https://www.youtube.com/embed/6s2n0FQ8k3E', thumbnailUrl:'https://img.youtube.com/vi/6s2n0FQ8k3E/hqdefault.jpg', order:3, isFree:true, durationSeconds:860 },
        { id:'ep_uiux_4', playbookId:'pb_uiux', title:'UI Systems & Components', description:'Atomic design crash.', embedUrl:'https://www.youtube.com/embed/_sKjKQp2kQg', thumbnailUrl:'https://img.youtube.com/vi/_sKjKQp2kQg/hqdefault.jpg', order:4, isFree:true, durationSeconds:910 },
        { id:'ep_uiux_5', playbookId:'pb_uiux', title:'Prototyping in Figma', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Prototype', order:5, isFree:false, durationSeconds:1000 },
        { id:'ep_uiux_6', playbookId:'pb_uiux', title:'UX Writing', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+UX+Writing', order:6, isFree:false, durationSeconds:900 },
        { id:'ep_uiux_7', playbookId:'pb_uiux', title:'Usability Testing', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Testing', order:7, isFree:false, durationSeconds:1000 },
        { id:'ep_uiux_8', playbookId:'pb_uiux', title:'Design Handoff', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Handoff', order:8, isFree:false, durationSeconds:950 },
        { id:'ep_ai_1', playbookId:'pb_ai', title:'AI/ML Landscape', description:'Intro to AI & ML.', embedUrl:'https://www.youtube.com/embed/GwIo3gDZCVQ', thumbnailUrl:'https://img.youtube.com/vi/GwIo3gDZCVQ/hqdefault.jpg', order:1, isFree:true, durationSeconds:900 },
        { id:'ep_ai_2', playbookId:'pb_ai', title:'Data Prep Pipelines', description:'Locked content placeholder', embedUrl:'', thumbnailUrl:'https://via.placeholder.com/480x270?text=Locked+Data', order:2, isFree:false, durationSeconds:1100 },
        { id:'ep_fullstack_1', playbookId:'pb_fullstack', title:'Full-Stack Foundations', description:'MERN overview.', embedUrl:'https://www.youtube.com/embed/3JluqTojuME', thumbnailUrl:'https://img.youtube.com/vi/3JluqTojuME/hqdefault.jpg', order:1, isFree:true, durationSeconds:960 },
        { id:'ep_ba_1', playbookId:'pb_ba', title:'Analytics Kickoff', description:'Excel dashboards.', embedUrl:'https://www.youtube.com/embed/mhQGZbV0BX4', thumbnailUrl:'https://img.youtube.com/vi/mhQGZbV0BX4/hqdefault.jpg', order:1, isFree:true, durationSeconds:840 },
        { id:'ep_startup_1', playbookId:'pb_startup', title:'Startup Mindset', description:'Intro to lean loops.', embedUrl:'https://www.youtube.com/embed/rxjBWkg3wG8', thumbnailUrl:'https://img.youtube.com/vi/rxjBWkg3wG8/hqdefault.jpg', order:1, isFree:true, durationSeconds:780 }
      ];
      const comments = [
        { id:'c1', userId:'u1', episodeId:'ep_py_1', content:'Great intro ‚Äî clear and fast!', createdAt:'2025-11-01T10:00:00Z' },
        { id:'c2', userId:'u1', episodeId:'ep_dm_2', content:'SEO tips were practical.', createdAt:'2025-11-02T11:00:00Z' }
      ];
      const purchases = [
        { id:'p1', userId:'u1', playbookId:'pb_python', amountTaka:499, provider:'card', providerPaymentId:'sim_init_001', status:'completed', createdAt:'2025-11-03T12:00:00Z' }
      ];
      const unlocks = [
        { id:'unlock_1', userId:'u1', playbookId:'pb_python', unlockedAt:'2025-11-03T12:00:01Z' }
      ];
      saveToStore(storeKeys.users, users);
      saveToStore(storeKeys.playbooks, playbooks);
      saveToStore(storeKeys.episodes, episodes);
      saveToStore(storeKeys.comments, comments);
      saveToStore(storeKeys.purchases, purchases);
      saveToStore(storeKeys.unlocks, unlocks);
    }
    function autoLogin() {
      let current = getFromStore(storeKeys.currentUser);
      const users = getFromStore(storeKeys.users) || [];
      if (!current) {
        const defaultUser = users.find(u => u.email === 'dev@edulylas.test');
        if (defaultUser) {
          current = { id: defaultUser.id, email: defaultUser.email, name: defaultUser.name, isCreator: defaultUser.isCreator };
          saveToStore(storeKeys.currentUser, current);
        }
      }
      return current;
    }

    function switchUser() {
      const current = getFromStore(storeKeys.currentUser);
      const users = getFromStore(storeKeys.users) || [];
      const next = current && current.email === 'dev@edulylas.test'
        ? users.find(u => u.email === 'creator@edulylas.test')
        : users.find(u => u.email === 'dev@edulylas.test');
      if (next) {
        saveToStore(storeKeys.currentUser, { id: next.id, email: next.email, name: next.name, isCreator: next.isCreator });
        document.dispatchEvent(new CustomEvent('edulylas:userSwitched'));
      }
    }

    function formatDuration(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return `${min}m ${sec.toString().padStart(2,'0')}s`;
    }

    function userHasUnlocked(playbookId, userId) {
      const unlocks = getFromStore(storeKeys.unlocks) || [];
      return unlocks.some(u => u.playbookId === playbookId && u.userId === userId);
    }

    function getThumbnail(item) {
      return item?.thumbnailUrl || fallbackThumbnail;
    }

    function renderNavUser() {
      const container = document.getElementById('navUser');
      const current = getFromStore(storeKeys.currentUser);
      if (!current) return;
      const users = getFromStore(storeKeys.users) || [];
      const userObj = users.find(u => u.id === current.id);
      container.innerHTML = `
        <div class="text-right">
          <p class="text-sm font-semibold">${current.name}</p>
          <p class="text-xs text-slate-500">${current.email}</p>
        </div>
        <img src="${userObj?.avatarUrl || fallbackThumbnail}" alt="${current.name} avatar" class="w-10 h-10 rounded-full border" loading="lazy"/>
      `;
    }

    function renderCategories() {
      const categories = ['Tech','Business','Marketing','Design','AI/ML','Freelancing'];
      const row = document.getElementById('categoryShortcuts');
      row.innerHTML = '';
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat;
        btn.className = 'px-4 py-2 rounded-full border border-slate-200 bg-white text-sm focus-ring';
        btn.addEventListener('click', () => filterByCategory(cat));
        row.appendChild(btn);
      });
    }

    function filterByCategory(cat) {
      const feed = document.getElementById('recommendedFeed');
      const cards = feed.querySelectorAll('[data-tags]');
      cards.forEach(card => {
        const tags = card.dataset.tags.split(',');
        card.style.display = tags.includes(cat) ? 'block' : 'none';
      });
    }

    function renderPlaybookCard(pb) {
      const freeCount = (getFromStore(storeKeys.episodes) || []).filter(ep => ep.playbookId === pb.id && ep.isFree).length;
      const card = document.createElement('article');
      card.className = 'playbook-card min-w-[240px] bg-white rounded-2xl shadow p-3 cursor-pointer hover:-translate-y-1 transition transform';
      card.innerHTML = `
        <div class="rounded-xl overflow-hidden">
          <img src="${getThumbnail(pb)}" alt="${pb.title} thumbnail" loading="lazy">
        </div>
        <div class="mt-2 space-y-1">
          <p class="text-xs uppercase text-slate-500">${pb.creatorName}</p>
          <h3 class="font-semibold">${pb.title}</h3>
          <p class="text-xs text-blue-500">${pb.tags.join(', ')}</p>
          <span class="inline-flex items-center text-xs mt-1 px-2 py-1 rounded-full bg-slate-100">${freeCount} Free ‚Ä¢ ${pb.totalEpisodes - freeCount} Paid</span>
        </div>`;
      card.addEventListener('click', () => {
        appState.activePlaybookId = pb.id;
        const firstEpisode = (getFromStore(storeKeys.episodes) || []).find(ep => ep.playbookId === pb.id);
        appState.activeEpisodeId = firstEpisode?.id || null;
        renderAll();
        document.getElementById('playbookPreview').scrollIntoView({ behavior: 'smooth' });
      });
      return card;
    }

    function renderTrending() {
      const playbooks = getFromStore(storeKeys.playbooks) || [];
      const trending = playbooks.slice(0, 4);
      const container = document.getElementById('trendingCarousel');
      container.innerHTML = '';
      trending.forEach(pb => container.appendChild(renderPlaybookCard(pb)));
    }

    function renderRecommended(listOverride) {
      const playbooks = getFromStore(storeKeys.playbooks) || [];
      const recommendedIds = ['pb_fullstack','pb_ba','pb_startup'];
      const container = document.getElementById('recommendedFeed');
      container.innerHTML = '';
      const data = listOverride?.length ? listOverride : playbooks.filter(pb => recommendedIds.includes(pb.id));
      data.forEach(pb => {
        const card = document.createElement('article');
        card.className = 'playbook-card bg-white rounded-2xl shadow flex flex-col md:flex-row gap-4 p-4 border border-transparent hover:border-blue-100 cursor-pointer';
        card.dataset.tags = pb.tags.join(',');
        card.innerHTML = `
          <div class="md:w-48 w-full rounded-xl overflow-hidden">
            <img src="${getThumbnail(pb)}" alt="${pb.title} cover" loading="lazy">
          </div>
          <div class="flex-1 space-y-1">
            <div class="flex items-center justify-between gap-3">
              <h3 class="text-lg font-semibold">${pb.title}</h3>
              <span class="text-sm font-bold text-blue-600">‡ß≥${pb.priceTaka}</span>
            </div>
            <p class="text-sm text-slate-600">${pb.description}</p>
            <div class="text-xs text-yellow-500">‚≠ê ${pb.rating}</div>
            <div class="flex gap-2 flex-wrap pt-1">
              ${pb.tags.map(tag => `<span class="px-2 py-1 bg-slate-100 rounded-full text-xs">${tag}</span>`).join('')}
            </div>
          </div>`;
        card.addEventListener('click', () => {
          appState.activePlaybookId = pb.id;
          const firstEpisode = (getFromStore(storeKeys.episodes) || []).find(ep => ep.playbookId === pb.id);
          appState.activeEpisodeId = firstEpisode?.id || null;
          renderAll();
        });
        container.appendChild(card);
      });
    }

    function buildEpisodeList(pb, unlocked) {
      const episodes = (getFromStore(storeKeys.episodes) || []).filter(ep => ep.playbookId === pb.id).sort((a,b) => a.order - b.order);
      const list = document.createElement('ul');
      list.className = 'episodes-list divide-y divide-slate-200';
      episodes.forEach(ep => {
        const li = document.createElement('li');
        const locked = !ep.isFree && !unlocked;
        li.className = 'py-3';
        li.innerHTML = `
          <button class="episode-toggle w-full text-left flex items-center gap-3 focus-ring" data-episode-id="${ep.id}" data-playbook-id="${pb.id}" data-locked="${locked}" aria-expanded="false">
            <img src="${getThumbnail(ep)}" alt="${ep.title}" class="w-20 h-12 rounded-lg object-cover" loading="lazy"/>
            <div class="flex-1">
              <div class="flex justify-between gap-2">
                <span class="font-semibold">${ep.order}. ${ep.title}</span>
                <span class="text-xs text-slate-500">${formatDuration(ep.durationSeconds)}</span>
              </div>
              <p class="text-sm text-slate-500">${ep.description}</p>
              <span class="text-xs ${ep.isFree ? 'text-green-600' : 'text-rose-500'}">${ep.isFree ? '‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá' : 'Locked ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ'}</span>
            </div>
            ${locked ? '<span class="material-icons text-rose-500" aria-hidden="true">lock</span>' : '<span class="material-icons text-slate-400">expand_more</span>'}
          </button>`;
        list.appendChild(li);
      });
      return list;
    }

    function normalizeYoutubeUrl(url) {
      if (!url) return '';
      try {
        const parsed = new URL(url);
        if (parsed.hostname.includes('youtu.be')) {
          const id = parsed.pathname.replace('/', '');
          return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
        }
        if (parsed.hostname.includes('youtube.com')) {
          const id = parsed.searchParams.get('v') || parsed.pathname.split('/').pop();
          return `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;
        }
        return url;
      } catch {
        return url;
      }
    }
    function renderEmbed(episode) {
      const wrapper = document.createElement('div');
      wrapper.className = 'space-y-2';
      const url = episode.embedUrl?.trim();
      if (!url) {
        wrapper.innerHTML = '<p class="text-sm text-slate-600">No embedded preview available yet.</p>';
        return wrapper;
      }
      const domain = url.includes('youtube') || url.includes('youtu.be') ? 'youtube' :
        url.includes('medium.com') ? 'medium' :
        url.includes('dev.to') ? 'devto' :
        url.includes('github.com') ? 'github' : 'other';
      if (domain === 'youtube') {
        const iframe = document.createElement('iframe');
        iframe.src = normalizeYoutubeUrl(url);
        iframe.width = '100%';
        iframe.height = '315';
        iframe.title = episode.title;
        iframe.className = 'rounded-xl w-full';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.allowFullscreen = true;
        wrapper.appendChild(iframe);
      } else if (domain === 'medium' || domain === 'devto') {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.width = '100%';
        iframe.height = '400';
        iframe.className = 'rounded-xl w-full border';
        iframe.title = `Embedded article for ${episode.title}`;
        iframe.allow = 'clipboard-write';
        iframe.allowFullscreen = true;
        wrapper.appendChild(iframe);
      } else if (domain === 'github') {
        wrapper.innerHTML = `
          <div class="border rounded-xl p-4 flex flex-col gap-2 bg-white">
            <div class="flex items-center gap-2">
              <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" class="w-8 h-8"/>
              <div>
                <p class="font-semibold">GitHub Repository</p>
                <p class="text-xs text-slate-500 truncate">${url}</p>
              </div>
            </div>
            <p class="text-sm text-slate-600">Preview unavailable in demo. Use the button below to open on GitHub.</p>
            <a href="${url}" target="_blank" rel="noopener" class="inline-flex items-center gap-1 text-blue-600 font-semibold">Open on GitHub<span class="material-icons text-base">open_in_new</span></a>
          </div>`;
      } else {
        wrapper.innerHTML = `
          <div class="border rounded-xl p-4">
            <p class="text-sm text-slate-600">Preview unavailable. Open externally to view the resource.</p>
          </div>`;
      }
      const external = document.createElement('a');
      external.href = url;
      external.target = '_blank';
      external.rel = 'noopener';
      external.className = 'inline-flex items-center gap-1 text-sm text-blue-600 font-semibold';
      external.textContent = 'Open externally';
      external.insertAdjacentHTML('beforeend', '<span class="material-icons text-base">open_in_new</span>');
      wrapper.appendChild(external);
      return wrapper;
    }

    function renderEpisodePanel(episode) {
      const panel = document.createElement('div');
      panel.className = 'episode-panel';
      panel.role = 'region';
      panel.dataset.episodePanel = episode.id;
      panel.innerHTML = `
        <p class="text-sm text-slate-600 mb-2">${episode.description || 'No description yet.'}</p>`;
      panel.appendChild(renderEmbed(episode));
      return panel;
    }

    function renderPlaybookPreview() {
      const playbooks = getFromStore(storeKeys.playbooks) || [];
      const episodes = getFromStore(storeKeys.episodes) || [];
      const currentUser = getFromStore(storeKeys.currentUser);
      const pb = playbooks.find(p => p.id === appState.activePlaybookId) || playbooks[0];
      if (!pb) return;
      appState.activePlaybookId = pb.id;
      const unlocked = userHasUnlocked(pb.id, currentUser?.id);
      const pbEpisodes = episodes.filter(ep => ep.playbookId === pb.id);
      const total = pb.totalEpisodes || pbEpisodes.length;
      const unlockedEpisodes = pbEpisodes.filter(ep => ep.isFree || unlocked).length;
      const progress = total ? Math.round((unlockedEpisodes / total) * 100) : 0;
      const container = document.getElementById('playbookPreview');
      container.innerHTML = `
        <div class="flex flex-col md:flex-row gap-4">
          <div class="md:w-60 w-full rounded-2xl overflow-hidden">
            <img src="${getThumbnail(pb)}" alt="${pb.title}" class="w-full h-auto" loading="lazy"/>
          </div>
          <div class="flex-1 space-y-3">
            <div class="flex flex-wrap justify-between gap-2">
              <div>
                <p class="text-xs uppercase text-slate-500">${pb.creatorName}</p>
                <h3 class="text-2xl font-bold">${pb.title}</h3>
              </div>
              <span class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-sm">${pb.difficulty}</span>
            </div>
            <p class="text-sm text-slate-600">${pb.description}</p>
            <div class="flex gap-2 flex-wrap">
              ${pb.tags.map(tag => `<span class='text-xs bg-slate-100 rounded-full px-3 py-1'>${tag}</span>`).join('')}
            </div>
            <div>
              <div class="w-full bg-slate-200 rounded-full h-2" aria-hidden="true">
                <div class="bg-blue-500 h-2 rounded-full" style="width:${progress}%"></div>
              </div>
              <p class="text-xs mt-1 text-slate-500" aria-live="polite">${unlockedEpisodes}/${total} episodes available (${progress}%)</p>
            </div>
            <div class="flex flex-wrap gap-3 items-center justify-between">
              <p class="text-lg font-semibold">Unlock all episodes for <span class="text-blue-600">‡ß≥${pb.priceTaka}</span></p>
              <button ${unlocked ? 'disabled' : ''} class="px-4 py-2 rounded-xl font-semibold ${unlocked ? 'bg-slate-200 text-slate-500 cursor-not-allowed' : 'bg-blue-600 text-white'}" data-playbook="${pb.id}" aria-label="Unlock full playbook">${unlocked ? 'Already unlocked' : 'Unlock Full Playbook ‚Ä¢ ‡ß≥'+pb.priceTaka}</button>
            </div>
          </div>
        </div>`;
      const actionBtn = container.querySelector('button[data-playbook]');
      if (actionBtn && !unlocked) {
        actionBtn.addEventListener('click', () => openPaymentModal(pb));
      }
      const episodeWrapper = document.createElement('div');
      episodeWrapper.className = 'mt-6';
      episodeWrapper.innerHTML = '<h4 class="font-semibold mb-2">Episode Preview</h4>';
      episodeWrapper.appendChild(buildEpisodeList(pb, unlocked));
      container.appendChild(episodeWrapper);
    }

    function renderPlaybookDetails() {
      const playbooks = getFromStore(storeKeys.playbooks) || [];
      const episodes = getFromStore(storeKeys.episodes) || [];
      const pb = playbooks.find(p => p.id === appState.activePlaybookId) || playbooks[0];
      if (!pb) return;
      const pbEpisodes = episodes.filter(ep => ep.playbookId === pb.id).sort((a,b) => a.order - b.order);
      const detail = document.getElementById('playbookDetails');
      detail.innerHTML = `
        <div class="flex flex-wrap items-center justify-between gap-2">
          <h3 class="text-xl font-semibold">Playbook Details</h3>
          <span class="text-sm text-slate-500">Rating ‚≠ê ${pb.rating}</span>
        </div>
        <p class="text-sm text-slate-600 mt-2">${pb.description}</p>
        <div class="mt-3 flex flex-wrap gap-2">
          ${pb.tags.map(tag => `<span class='px-3 py-1 rounded-full bg-slate-100 text-xs'>${tag}</span>`).join('')}
        </div>
        <div class="mt-4 space-y-2">
          ${pbEpisodes.map(ep => `<div class='flex items-center justify-between border rounded-xl px-3 py-2 text-sm'>
            <span>${ep.order}. ${ep.title}</span>
            <span>${ep.isFree ? '‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá' : 'üîí'}</span>
          </div>`).join('')}
        </div>`;
    }

    function renderEpisodePlayer() {
      const container = document.getElementById('episodePlayer');
      const episodes = getFromStore(storeKeys.episodes) || [];
      const playbooks = getFromStore(storeKeys.playbooks) || [];
      const currentEpisode = episodes.find(ep => ep.id === appState.activeEpisodeId) || episodes.find(ep => ep.playbookId === appState.activePlaybookId);
      if (!currentEpisode) {
        container.innerHTML = '<p class="text-sm text-slate-500">Select an episode to preview.</p>';
        return;
      }
      const playbook = playbooks.find(pb => pb.id === currentEpisode.playbookId);
      container.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div>
            <p class="text-xs uppercase text-slate-500">Now previewing</p>
            <h3 class="text-xl font-semibold">${currentEpisode.title}</h3>
            <p class="text-sm text-slate-500">${playbook?.title || ''}</p>
          </div>
          <span class="text-xs text-slate-500">${formatDuration(currentEpisode.durationSeconds)}</span>
        </div>`;
      container.appendChild(renderEpisodePanel(currentEpisode));
    }

    function renderCreatorPanel() {
      const current = getFromStore(storeKeys.currentUser);
      const panel = document.getElementById('creatorPanel');
      panel.classList.toggle('hidden', !current?.isCreator);
      if (!current?.isCreator) return;
      panel.innerHTML = `
        <h3 class="text-xl font-semibold">Creator Console</h3>
        <p class="text-sm text-slate-500">Submit new playbooks or schedule episodes.</p>
        <form id="createPlaybookForm" class="grid md:grid-cols-2 gap-4 mt-4">
          <label class="text-sm">Title<input name="title" required class="mt-1 border rounded-xl px-3 py-2 w-full" placeholder="Playbook title"/></label>
          <label class="text-sm">Difficulty<input name="difficulty" class="mt-1 border rounded-xl px-3 py-2 w-full" placeholder="Beginner"/></label>
          <label class="text-sm md:col-span-2">Description<textarea name="description" class="mt-1 border rounded-xl px-3 py-2 w-full" rows="2"></textarea></label>
          <label class="text-sm">Tags<input name="tags" class="mt-1 border rounded-xl px-3 py-2 w-full" placeholder="Tech, Programming"/></label>
          <label class="text-sm">Price (‡ß≥)<input name="price" type="number" class="mt-1 border rounded-xl px-3 py-2 w-full"/></label>
          <label class="text-sm">Thumbnail URL<input name="thumbnail" class="mt-1 border rounded-xl px-3 py-2 w-full"/></label>
          <label class="text-sm">Rating<input name="rating" type="number" step="0.1" class="mt-1 border rounded-xl px-3 py-2 w-full"/></label>
          <button class="md:col-span-2 bg-slate-900 text-white rounded-xl py-2">Add Playbook</button>
        </form>
        <hr class="my-6"/>
        <form id="addEpisodeForm" class="grid md:grid-cols-2 gap-4">
          <label class="text-sm">Playbook<select name="playbookId" class="mt-1 border rounded-xl px-3 py-2 w-full"></select></label>
          <label class="text-sm">Title<input name="title" required class="mt-1 border rounded-xl px-3 py-2 w-full"/></label>
          <label class="text-sm md:col-span-2">Embed URL<input name="embed" required class="mt-1 border rounded-xl px-3 py-2 w-full" placeholder="https://www.youtube.com/watch?v=..."/></label>
          <label class="text-sm">Thumbnail URL<input name="thumbnail" class="mt-1 border rounded-xl px-3 py-2 w-full"/></label>
          <label class="text-sm">Duration (seconds)<input name="duration" type="number" class="mt-1 border rounded-xl px-3 py-2 w-full"/></label>
          <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="isFree"/> Free episode</label>
          <button class="md:col-span-2 bg-blue-600 text-white rounded-xl py-2">Add Episode</button>
          <p id="creatorValidation" class="md:col-span-2 text-sm text-rose-500"></p>
        </form>`;
      const select = panel.querySelector('select[name="playbookId"]');
      const playbooks = getFromStore(storeKeys.playbooks).filter(pb => pb.creatorId === current.id || current.email === 'creator@edulylas.test');
      playbooks.forEach(pb => {
        const option = document.createElement('option');
        option.value = pb.id;
        option.textContent = pb.title;
        select.appendChild(option);
      });
      panel.querySelector('#createPlaybookForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = new FormData(e.target);
        const newPb = {
          id: 'pb_'+Date.now(),
          slug: form.get('title').toLowerCase().replace(/\s+/g,'-'),
          title: form.get('title'),
          creatorId: current.id,
          creatorName: current.name,
          description: form.get('description'),
          tags: form.get('tags').split(',').map(t => t.trim()),
          difficulty: form.get('difficulty'),
          rating: parseFloat(form.get('rating')) || 4.5,
          priceTaka: Number(form.get('price')) || 299,
          thumbnailUrl: form.get('thumbnail'),
          totalEpisodes: 0,
          createdAt: new Date().toISOString()
        };
        const playbooksStore = getFromStore(storeKeys.playbooks) || [];
        playbooksStore.unshift(newPb);
        saveToStore(storeKeys.playbooks, playbooksStore);
        e.target.reset();
        renderAll();
      });
      panel.querySelector('#addEpisodeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const status = panel.querySelector('#creatorValidation');
        status.textContent = '';
        const form = new FormData(e.target);
        const embed = form.get('embed');
        if (!allowedEmbedDomains.some(domain => embed.includes(domain))) {
          status.textContent = 'Embed URL must be from youtube.com, youtu.be, medium.com, or dev.to';
          return;
        }
        const playbookId = form.get('playbookId');
        const episodes = getFromStore(storeKeys.episodes) || [];
        const order = episodes.filter(ep => ep.playbookId === playbookId).length + 1;
        episodes.push({ id:'ep_'+Date.now(), playbookId, title: form.get('title'), description: 'Creator submitted episode', embedUrl: embed, thumbnailUrl: form.get('thumbnail'), order, isFree: form.get('isFree') === 'on', durationSeconds: Number(form.get('duration')) });
        saveToStore(storeKeys.episodes, episodes);
        const playbooksStore = getFromStore(storeKeys.playbooks) || [];
        const pb = playbooksStore.find(p => p.id === playbookId);
        if (pb) {
          pb.totalEpisodes = episodes.filter(ep => ep.playbookId === playbookId).length;
          saveToStore(storeKeys.playbooks, playbooksStore);
        }
        e.target.reset();
        renderAll();
      });
    }
    function renderProfilePanel() {
      const user = getFromStore(storeKeys.currentUser);
      const purchases = getFromStore(storeKeys.purchases) || [];
      const playbooks = getFromStore(storeKeys.playbooks) || [];
      const container = document.getElementById('profilePanel');
      container.innerHTML = `
        <h3 class="text-xl font-semibold">Profile & Activity</h3>
        <p class="text-sm text-slate-500">${user?.email || 'Not signed in'}</p>
        <div class="mt-4">
          <h4 class="font-semibold">Purchases</h4>
          <div class="space-y-3 mt-2" id="purchaseList"></div>
        </div>
        <button id="resetDemo" class="mt-4 bg-rose-600 text-white px-4 py-2 rounded-xl focus-ring">Reset Demo Data</button>
      `;
      const list = container.querySelector('#purchaseList');
      const userPurchases = purchases.filter(p => p.userId === user?.id);
      if (!userPurchases.length) {
        list.innerHTML = '<p class="text-sm text-slate-500">No purchases yet</p>';
      } else {
        userPurchases.forEach(p => {
          const pb = playbooks.find(pb => pb.id === p.playbookId);
          const row = document.createElement('div');
          row.className = 'border rounded-xl p-3';
          row.innerHTML = `<p class='font-semibold'>${pb?.title || p.playbookId}</p><p class='text-sm text-slate-500'>‡ß≥${p.amountTaka} ‚Ä¢ ${p.provider} ‚Ä¢ ${p.status}</p><p class='text-xs text-slate-400 font-mono'>${p.providerPaymentId}</p>`;
          list.appendChild(row);
        });
      }
      container.querySelector('#resetDemo').addEventListener('click', () => {
        Object.values(storeKeys).forEach(key => localStorage.removeItem(key));
        seedData(true);
        autoLogin();
        renderAll();
      });
    }

    function applySearch(value) {
      const query = value.toLowerCase();
      const playbooks = getFromStore(storeKeys.playbooks) || [];
      const filtered = playbooks.filter(pb => pb.title.toLowerCase().includes(query) || pb.description.toLowerCase().includes(query));
      renderRecommended(query ? filtered : null);
    }

    function handleNav(view) {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('text-blue-600', btn.dataset.view === view);
        btn.setAttribute('aria-current', btn.dataset.view === view ? 'page' : 'false');
      });
      if (view === 'search') {
        document.getElementById('searchInput').focus();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else if (view === 'creator') {
        document.getElementById('creatorPanel').scrollIntoView({ behavior: 'smooth' });
      } else if (view === 'profile') {
        document.getElementById('profilePanel').scrollIntoView({ behavior: 'smooth' });
      } else {
        document.getElementById('appRoot').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function openPaymentModal(pb) {
      if (!pb) return;
      document.getElementById('paymentPlaybookTitle').textContent = `${pb.title} ‚Ä¢ ‡ß≥${pb.priceTaka}`;
      document.getElementById('payAmountLabel').textContent = pb.priceTaka;
      document.getElementById('paymentModal').classList.remove('hidden');
      document.getElementById('paymentModal').classList.add('flex');
      document.getElementById('paymentModal').dataset.playbookId = pb.id;
      setPaymentTab('card');
      trapFocus(document.querySelector('#paymentModal .modal-shell'));
    }

    function closePaymentModal() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('paymentModal').classList.remove('flex');
      document.getElementById('paymentStatus').textContent = '';
      releaseFocus();
    }

    function openReceiptModal(details) {
      document.getElementById('receiptPlaybook').textContent = details.playbook;
      document.getElementById('receiptAmount').textContent = `‡ß≥${details.amount}`;
      document.getElementById('receiptProvider').textContent = details.provider;
      document.getElementById('receiptTxn').textContent = details.txn;
      document.getElementById('receiptDate').textContent = new Date(details.date).toLocaleString();
      document.getElementById('receiptModal').classList.remove('hidden');
      document.getElementById('receiptModal').classList.add('flex');
      trapFocus(document.querySelector('#receiptModal .modal-shell'));
    }

    function closeReceiptModal() {
      document.getElementById('receiptModal').classList.add('hidden');
      document.getElementById('receiptModal').classList.remove('flex');
      releaseFocus();
    }

    function setPaymentTab(provider) {
      appState.pendingProvider = provider;
      document.querySelectorAll('.payment-tab').forEach(btn => {
        btn.classList.toggle('tab-active', btn.dataset.provider === provider);
        btn.setAttribute('aria-selected', btn.dataset.provider === provider);
      });
      const content = document.getElementById('paymentContent');
      if (provider === 'card') {
        content.innerHTML = `
          <label class="block text-sm">Card number
            <input id="cardNumber" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="4242 4242 4242 4242" inputmode="numeric" autocomplete="cc-number" required />
          </label>
          <div class="flex gap-3">
            <label class="flex-1 text-sm">Expiry (MM/YY)
              <input id="cardExpiry" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="12/29" inputmode="numeric" autocomplete="cc-exp" required />
            </label>
            <label class="flex-1 text-sm">CVC
              <input id="cardCvc" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="123" inputmode="numeric" autocomplete="cc-csc" required />
            </label>
          </div>`;
        bindCardMasks();
      } else if (provider === 'bkash') {
        content.innerHTML = `
          <label class="block text-sm">bKash Number
            <input id="bkashNumber" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="01XXXXXXXXX" inputmode="numeric" required />
          </label>
          <p class="text-xs text-slate-500">Approve inside your bKash app, then tap pay.</p>`;
      } else {
        content.innerHTML = `
          <label class="block text-sm">Nagad Number
            <input id="nagadNumber" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="01XXXXXXXXX" inputmode="numeric" required />
          </label>
          <p class="text-xs text-amber-600">First attempt may fail‚Äîuse retry to simulate OTP timeout.</p>`;
      }
    }

    function bindCardMasks() {
      const cardInput = document.getElementById('cardNumber');
      cardInput.addEventListener('input', () => {
        let value = cardInput.value.replace(/\D/g, '').slice(0,16);
        cardInput.value = value.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
      });
      const expiryInput = document.getElementById('cardExpiry');
      expiryInput.addEventListener('input', () => {
        let value = expiryInput.value.replace(/\D/g,'').slice(0,4);
        if (value.length > 2) value = `${value.slice(0,2)}/${value.slice(2)}`;
        expiryInput.value = value;
      });
      const cvcInput = document.getElementById('cardCvc');
      cvcInput.addEventListener('input', () => {
        cvcInput.value = cvcInput.value.replace(/\D/g,'').slice(0,4);
      });
    }

    function validateCardForm() {
      const number = document.getElementById('cardNumber').value.replace(/\s/g,'');
      const expiry = document.getElementById('cardExpiry').value;
      const cvc = document.getElementById('cardCvc').value;
      if (!luhnCheck(number)) return 'Invalid card number';
      const [mm, yy] = expiry.split('/');
      if (!mm || !yy) return 'Invalid expiry';
      const expDate = new Date(`20${yy}`, Number(mm)-1, 1);
      if (expDate < new Date()) return 'Card expired';
      if (cvc.length < 3) return 'Invalid CVC';
      return null;
    }

    function luhnCheck(number) {
      let sum = 0; let shouldDouble = false;
      for (let i = number.length - 1; i >= 0; i--) {
        let digit = parseInt(number.charAt(i), 10);
        if (shouldDouble) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }
        sum += digit;
        shouldDouble = !shouldDouble;
      }
      return sum % 10 === 0;
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed top-20 left-1/2 -translate-x-1/2 z-[1400] px-4 py-2 rounded-xl shadow-lg text-sm ${isError ? 'bg-rose-600 text-white' : 'bg-emerald-600 text-white'}`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
    function startPayment() {
      if (appState.processingPayment) return;
      const playbookId = document.getElementById('paymentModal').dataset.playbookId;
      const playbook = (getFromStore(storeKeys.playbooks) || []).find(pb => pb.id === playbookId);
      if (!playbook) return;
      const user = getFromStore(storeKeys.currentUser);
      if (!user) {
        showToast('Please login first', true);
        return;
      }
      if (userHasUnlocked(playbook.id, user.id)) {
        showToast('Playbook already unlocked', false);
        closePaymentModal();
        return;
      }
      const provider = appState.pendingProvider;
      if (provider === 'card') {
        const error = validateCardForm();
        if (error) {
          showToast(error, true);
          return;
        }
      }
      appState.processingPayment = true;
      document.getElementById('payNowBtn').setAttribute('disabled', 'true');
      document.getElementById('paymentStatus').innerHTML = '<div class="text-sm text-blue-600">Verifying payment‚Ä¶</div>';
      const purchase = {
        id: 'purchase_'+Date.now(),
        userId: user.id,
        playbookId: playbook.id,
        amountTaka: playbook.priceTaka,
        provider,
        providerPaymentId: 'sim_'+uuidv4(),
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      processPurchase(purchase)
        .then(record => {
          appState.processingPayment = false;
          document.getElementById('payNowBtn').removeAttribute('disabled');
          document.getElementById('paymentStatus').innerHTML = '<div class="text-sm text-emerald-600">Payment verified.</div>';
          closePaymentModal();
          openReceiptModal({ playbook: playbook.title, amount: record.amountTaka, provider: provider.toUpperCase(), txn: record.providerPaymentId, date: record.createdAt });
          showToast('Playbook unlocked!');
        })
        .catch(err => {
          appState.processingPayment = false;
          document.getElementById('payNowBtn').removeAttribute('disabled');
          document.getElementById('paymentStatus').innerHTML = `<div class="text-sm text-rose-600">${err.message || 'Payment failed. Please retry.'}</div>`;
          showToast(err.message || 'Payment failed. Retry?', true);
        });
    }

    // UPDATED: processPurchase - transactional unlock + uuid
    function processPurchase(purchase) {
      return new Promise((resolve, reject) => {
        const unlocks = getFromStore(storeKeys.unlocks) || [];
        if (unlocks.some(u => u.playbookId === purchase.playbookId && u.userId === purchase.userId)) {
          reject(new Error('Already unlocked'));
          return;
        }
        const purchases = getFromStore(storeKeys.purchases) || [];
        purchases.push(purchase);
        saveToStore(storeKeys.purchases, purchases);
        const simulateVerification = new Promise((res, rej) => {
          setTimeout(() => {
            if (appState.debug.webhookFailure && appState.nagadAttempts === 0) {
              rej(new Error('Webhook verification failed. Retry?'));
            } else if (purchase.provider === 'nagad' && appState.nagadAttempts === 0) {
              appState.nagadAttempts += 1;
              rej(new Error('Nagad OTP expired. Try again.'));
            } else {
              res(true);
            }
          }, 1500);
        });
        simulateVerification.then(() => {
          purchase.status = 'completed';
          const updatedPurchases = purchases.map(p => p.id === purchase.id ? purchase : p);
          saveToStore(storeKeys.purchases, updatedPurchases);
          const unlockRecord = { id: 'unlock_'+uuidv4(), userId: purchase.userId, playbookId: purchase.playbookId, unlockedAt: new Date().toISOString() };
          unlocks.push(unlockRecord);
          saveToStore(storeKeys.unlocks, unlocks);
          document.dispatchEvent(new CustomEvent('purchase:completed', { detail: { purchase } }));
          resolve(purchase);
        }).catch(err => {
          purchase.status = 'failed';
          const updatedPurchases = purchases.map(p => p.id === purchase.id ? purchase : p);
          saveToStore(storeKeys.purchases, updatedPurchases);
          reject(err);
        });
      });
    }

    function trapFocus(modal) {
      const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      function handle(e) {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        } else if (e.key === 'Escape') {
          closePaymentModal();
          closeReceiptModal();
        }
      }
      modal.addEventListener('keydown', handle);
      appState.focusTrap = { modal, handle };
      first?.focus();
    }

    function releaseFocus() {
      if (appState.focusTrap) {
        appState.focusTrap.modal.removeEventListener('keydown', appState.focusTrap.handle);
        appState.focusTrap = null;
      }
    }

    function toggleEpisodePanel(button) {
      const episodeId = button.dataset.episodeId;
      const locked = button.dataset.locked === 'true';
      const playbookId = button.dataset.playbookId;
      const playbook = (getFromStore(storeKeys.playbooks) || []).find(pb => pb.id === playbookId);
      if (locked) {
        openPaymentModal(playbook);
        return;
      }
      const list = button.closest('.episodes-list');
      const existingPanel = list.querySelector('.episode-panel');
      list.querySelectorAll('.episode-toggle').forEach(toggle => toggle.setAttribute('aria-expanded', 'false'));
      if (existingPanel) existingPanel.remove();
      if (existingPanel && existingPanel.dataset.episodePanel === episodeId) {
        return;
      }
      const episodes = getFromStore(storeKeys.episodes) || [];
      const episode = episodes.find(ep => ep.id === episodeId);
      if (!episode) return;
      const panel = renderEpisodePanel(episode);
      const parentLi = button.closest('li');
      parentLi.insertAdjacentElement('afterend', panel);
      button.setAttribute('aria-expanded', 'true');
      appState.activeEpisodeId = episode.id;
      renderEpisodePlayer();
    }

    function initEpisodeDelegation() {
      document.addEventListener('click', (event) => {
        const toggle = event.target.closest('.episode-toggle');
        if (toggle) {
          toggleEpisodePanel(toggle);
        }
      });
    }

    function updateDebugPanel() {
      document.getElementById('storageDump').textContent = JSON.stringify(localStorage, null, 2);
      document.getElementById('failWebhookToggle').checked = appState.debug.webhookFailure;
    }

    function initDebugPanel() {
      const toggleBtn = document.getElementById('debugToggle');
      const panel = document.getElementById('debugPanel');
      toggleBtn.addEventListener('click', () => {
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        toggleBtn.setAttribute('aria-expanded', String(!expanded));
        panel.classList.toggle('hidden');
        if (!expanded) {
          updateDebugPanel();
        }
      });
      document.getElementById('failWebhookToggle').addEventListener('change', (e) => {
        appState.debug.webhookFailure = e.target.checked;
      });
      document.getElementById('forceReseed').addEventListener('click', () => {
        Object.values(storeKeys).forEach(key => localStorage.removeItem(key));
        seedData(true);
        autoLogin();
        renderAll();
        updateDebugPanel();
      });
      document.getElementById('refreshStorage').addEventListener('click', updateDebugPanel);
    }

    function renderAll() {
      renderNavUser();
      renderCategories();
      renderTrending();
      renderRecommended();
      renderPlaybookPreview();
      renderPlaybookDetails();
      renderEpisodePlayer();
      renderCreatorPanel();
      renderProfilePanel();
    }

    function initApp() {
      seedData();
      autoLogin();
      renderAll();
      document.getElementById('creatorToggle').addEventListener('click', switchUser);
      document.getElementById('searchInput').addEventListener('input', (e) => applySearch(e.target.value));
      document.getElementById('searchInputMobile').addEventListener('input', (e) => {
        document.getElementById('searchInput').value = e.target.value;
        applySearch(e.target.value);
      });
      document.querySelectorAll('.payment-tab').forEach(btn => btn.addEventListener('click', () => setPaymentTab(btn.dataset.provider)));
      document.getElementById('closePayment').addEventListener('click', closePaymentModal);
      document.getElementById('closeReceipt').addEventListener('click', closeReceiptModal);
      document.getElementById('payNowBtn').addEventListener('click', () => startPayment());
      document.getElementById('printReceipt').addEventListener('click', () => window.print());
      document.getElementById('viewPlaybookBtn').addEventListener('click', () => {
        closeReceiptModal();
        document.getElementById('playbookPreview').scrollIntoView({ behavior: 'smooth' });
      });
      document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => handleNav(btn.dataset.view)));
      document.addEventListener('edulylas:userSwitched', () => {
        renderAll();
      });
      document.addEventListener('purchase:completed', () => {
        renderPlaybookPreview();
        renderEpisodePlayer();
        renderProfilePanel();
      });
      initEpisodeDelegation();
      initDebugPanel();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
